<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Chatroom</title>
    <link rel="stylesheet" href="admin-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="admin-panel">
            <div class="header">
                <h1>üõ†Ô∏è Admin Dashboard</h1>
                <p>Chatroom User Management - Welcome, Ori!</p>
                <div class="admin-actions">
                    <button id="refresh-btn" class="refresh-btn">üîÑ Refresh Data</button>
                    <button id="logout-btn" class="logout-btn">üö™ Logout</button>
                    <a href="/" class="back-btn">‚Üê Back to Chatroom</a>
                </div>
            </div>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-logins">0</div>
                    <div class="stat-label">Recent Logins (24h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="new-users">0</div>
                    <div class="stat-label">New Users (24h)</div>
                </div>
            </div>
            
            <div class="users-section">
                <h2>üë• All Users</h2>
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created At</th>
                                <th>Last Login</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td colspan="4" class="no-data">Loading user data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="actions-section">
                <h2>‚öôÔ∏è Quick Actions</h2>
                <div class="action-buttons">
                    <button id="export-btn" class="action-btn">üìä Export User Data</button>
                    <button id="view-api-btn" class="action-btn">üîó View Raw API Data</button>
                </div>
            </div>
        </div>
        
        <div class="background-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
        </div>
    </div>
    
    <script type="module">
        import { API_CONFIG } from './config.js';

        // Global variables
        const usersTbody = document.getElementById('users-tbody');
        const totalUsersEl = document.getElementById('total-users');
        const recentLoginsEl = document.getElementById('recent-logins');
        const newUsersEl = document.getElementById('new-users');
        let usersData = [];

        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize the dashboard
            await initDashboard();
        });

        // Check admin authentication
        async function checkAdminAuth() {
            try {
                const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.ADMIN_STATS), {
                    credentials: 'include'  // Important for sending cookies
                });
                
                if (!response.ok) {
                    window.location.href = '/admin-login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/admin-login.html';
                return false;
            }
        }
        
        // Initialize the dashboard
        async function initDashboard() {
            const isAuthenticated = await checkAdminAuth();
            if (!isAuthenticated) return;
            
            setupEventListeners();
            await loadUserData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadUserData, 30000);
        }
        
        function setupEventListeners() {
            const refreshBtn = document.getElementById('refresh-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const exportBtn = document.getElementById('export-btn');
            const viewApiBtn = document.getElementById('view-api-btn');
            
            if (refreshBtn) refreshBtn.addEventListener('click', loadUserData);
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    try {
                        await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.ADMIN_LOGOUT), {
                            method: 'POST',
                            credentials: 'include'
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                    window.location.href = '/admin-login.html';
                });
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', exportUserData);
            }

            if (viewApiBtn) {
                viewApiBtn.addEventListener('click', () => {
                    window.open(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.ADMIN_STATS), '_blank');
                });
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.ADMIN_STATS), {
                    credentials: 'include'  // Important for sending cookies
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Unauthorized - redirect to login
                        window.location.href = '/admin-login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                    
                    const data = await response.json();

                    // Update stats
                    totalUsersEl.textContent = data.totalUsers || 0;
                    recentLoginsEl.textContent = data.recentLogins || 0;
                    newUsersEl.textContent = data.newUsers || 0;

                    // Update users table
                    updateUsersTable(data.users || []);
                    
                    // Store users data for export
                    usersData = data.users || [];

                } catch (error) {
                    console.error('Failed to load user data:', error);
                    usersTableBody.innerHTML = '<tr><td colspan="4" class="no-data">Failed to load user data. Please try again.</td></tr>';
                    showNotification('Failed to load user data', 'error');
                }
            }

            function updateUsersTable(users) {
                if (users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="4" class="no-data">No users registered yet</td></tr>';
                    return;
                }

                const now = new Date();
                const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
                
                usersTableBody.innerHTML = users.map(user => {
                    const lastLogin = user.last_login ? new Date(user.last_login) : null;
                    const isOnline = lastLogin && lastLogin > fiveMinutesAgo;
                    
                    return `
                        <tr>
                            <td>${escapeHtml(user.name)}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>${lastLogin ? formatDate(lastLogin) : 'Never'}</td>
                            <td><span class="status-badge ${isOnline ? 'online' : 'offline'}">
                                ${isOnline ? 'Online' : 'Offline'}
                            </span></td>
                        </tr>
                    `;
                }).join('');
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Invalid date';
                
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async function exportUserData() {
                try {
                    const response = await fetch('/api/stats', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch data');
                    
                    const data = await response.json();
                    
                    // Convert to CSV
                    const headers = ['Name', 'Created At', 'Last Login', 'Status'];
                    const rows = data.users.map(user => {
                        const lastLogin = user.last_login ? new Date(user.last_login) : null;
                        const now = new Date();
                        const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
                        const isOnline = lastLogin && lastLogin > fiveMinutesAgo;
                        
                        return [
                            `"${user.name.replace(/"/g, '""')}"`,
                            `"${new Date(user.created_at).toISOString()}"`,
                            `"${lastLogin ? lastLogin.toISOString() : 'Never'}"`,
                            `"${isOnline ? 'Online' : 'Offline'}"`
                        ].join(',');
                    });
                    
                    const csvContent = [
                        headers.join(','),
                        ...rows
                    ].join('\n');
                    
                    // Download the file
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `users-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('Data exported successfully!', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    showNotification('Failed to export data', 'error');
                }
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Add show class after a small delay to allow for CSS transition
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    
                    // Remove from DOM after transition
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
                
                // Click to dismiss
                notification.addEventListener('click', () => {
                    notification.classList.remove('show');
                    
                    // Remove from DOM after transition
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                });
            }

            // Auto-refresh every 30 seconds
            setInterval(loadUserData, 30000);
        });
    </script>
</body>
</html>
