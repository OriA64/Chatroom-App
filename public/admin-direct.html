<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Chatroom</title>
    <link rel="stylesheet" href="admin-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="admin-panel">
            <div class="header">
                <h1>üõ†Ô∏è Admin Dashboard</h1>
                <p>Chatroom User Management</p>
                <div class="admin-actions">
                    <button id="refresh-btn" class="refresh-btn">üîÑ Refresh Data</button>
                    <a href="/" class="back-btn">‚Üê Back to Chatroom</a>
                </div>
            </div>
            
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-logins">0</div>
                    <div class="stat-label">Recent Logins (24h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="new-users">0</div>
                    <div class="stat-label">New Users (24h)</div>
                </div>
            </div>
            
            <div class="users-section">
                <h2>üë• All Users</h2>
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created At</th>
                                <th>Last Login</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td colspan="4" class="no-data">Loading user data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="actions-section">
                <h2>‚öôÔ∏è Quick Actions</h2>
                <div class="action-buttons">
                    <button id="export-btn" class="action-btn">üìä Export User Data</button>
                    <button id="view-api-btn" class="action-btn">üîó View Raw API Data</button>
                </div>
            </div>
        </div>
        
        <div class="background-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
        </div>
    </div>
    
    <script>
        // Use the same admin script but with API endpoint adjustments
        document.addEventListener('DOMContentLoaded', function() {
            const refreshBtn = document.getElementById('refresh-btn');
            const exportBtn = document.getElementById('export-btn');
            const viewApiBtn = document.getElementById('view-api-btn');
            const totalUsersEl = document.getElementById('total-users');
            const recentLoginsEl = document.getElementById('recent-logins');
            const newUsersEl = document.getElementById('new-users');
            const usersTableBody = document.getElementById('users-tbody');

            // Load data on page load
            loadUserData();

            // Refresh button
            refreshBtn.addEventListener('click', () => {
                refreshBtn.textContent = 'üîÑ Loading...';
                refreshBtn.disabled = true;
                loadUserData().finally(() => {
                    refreshBtn.textContent = 'üîÑ Refresh Data';
                    refreshBtn.disabled = false;
                });
            });

            // Export button
            exportBtn.addEventListener('click', exportUserData);

            // View API button
            viewApiBtn.addEventListener('click', () => {
                window.open('/api/stats', '_blank');
            });

            async function loadUserData() {
                try {
                    // Try serverless function first, fallback to local API
                    let response;
                    try {
                        response = await fetch('/.netlify/functions/stats');
                    } catch (e) {
                        response = await fetch('/api/stats');
                    }
                    
                    const data = await response.json();

                    // Update stats
                    totalUsersEl.textContent = data.totalUsers || 0;
                    
                    // Calculate recent logins (last 24 hours)
                    const now = new Date();
                    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    
                    let recentLogins = 0;
                    let newUsers = 0;

                    if (data.users) {
                        data.users.forEach(user => {
                            if (user.last_login) {
                                const lastLogin = new Date(user.last_login);
                                if (lastLogin > yesterday) {
                                    recentLogins++;
                                }
                            }
                            
                            const createdAt = new Date(user.created_at);
                            if (createdAt > yesterday) {
                                newUsers++;
                            }
                        });
                    }

                    recentLoginsEl.textContent = recentLogins;
                    newUsersEl.textContent = newUsers;

                    // Update users table
                    updateUsersTable(data.users || []);

                } catch (error) {
                    console.error('Failed to load user data:', error);
                    usersTableBody.innerHTML = '<tr><td colspan="4" class="no-data">Failed to load user data. Make sure the server is running.</td></tr>';
                }
            }

            function updateUsersTable(users) {
                if (users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="4" class="no-data">No users registered yet</td></tr>';
                    return;
                }

                const now = new Date();
                const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);

                usersTableBody.innerHTML = users.map(user => {
                    const createdAt = new Date(user.created_at);
                    const lastLogin = user.last_login ? new Date(user.last_login) : null;
                    
                    // Determine status (online if logged in within last 5 minutes)
                    const isOnline = lastLogin && lastLogin > fiveMinutesAgo;
                    const statusClass = isOnline ? 'status-online' : 'status-offline';
                    const statusText = isOnline ? 'Online' : 'Offline';

                    return `
                        <tr>
                            <td><strong>${escapeHtml(user.name)}</strong></td>
                            <td>${formatDate(createdAt)}</td>
                            <td>${lastLogin ? formatDate(lastLogin) : 'Never'}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                }).join('');
            }

            function formatDate(date) {
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async function exportUserData() {
                try {
                    let response;
                    try {
                        response = await fetch('/.netlify/functions/stats');
                    } catch (e) {
                        response = await fetch('/api/stats');
                    }
                    
                    const data = await response.json();
                    
                    const csvContent = "data:text/csv;charset=utf-8," 
                        + "Name,Created At,Last Login\n"
                        + (data.users || []).map(user => 
                            `"${user.name}","${user.created_at}","${user.last_login || 'Never'}"`
                        ).join('\n');

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', `chatroom_users_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('User data exported successfully!', 'success');
                } catch (error) {
                    console.error('Export failed:', error);
                    showNotification('Failed to export user data', 'error');
                }
            }

            function showNotification(message, type) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 16px 24px;
                    border-radius: 12px;
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    animation: slideIn 0.3s ease-out;
                `;
                
                const colors = {
                    success: 'linear-gradient(135deg, #48bb78, #38a169)',
                    error: 'linear-gradient(135deg, #f56565, #e53e3e)',
                    info: 'linear-gradient(135deg, #667eea, #764ba2)'
                };
                
                notification.style.background = colors[type] || colors.info;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            // Auto-refresh every 30 seconds
            setInterval(loadUserData, 30000);
        });
    </script>
</body>
</html>
